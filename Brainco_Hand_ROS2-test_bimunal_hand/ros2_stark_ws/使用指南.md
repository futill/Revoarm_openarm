# Vision Pro 手势控制灵巧手 - 完整使用指南

## ✅ 已创建的文件

```
ros2_stark_ws/
├── hand_control_bridge.py     ✓ 桥接节点主程序
├── start_bridge.sh             ✓ 桥接节点启动脚本  
├── test_hand_control.py        ✓ 测试脚本主程序
├── run_test.sh                 ✓ 测试脚本启动器
├── HAND_CONTROL_README.md      ✓ 详细使用说明
├── QUICK_START.txt             ✓ 快速参考卡片
└── 使用指南.md                 ✓ 本文件
```

所有脚本都已添加可执行权限（chmod +x）。

---

## 🚀 三步启动流程

### 第 1 步：启动硬件控制节点

**终端 1** 运行：
```bash
cd /home/scy/stark-serialport-example/ros2_stark_ws
./stark_serial_manager.sh launch
```

**预期输出：**
```
Launching left hand node (stark_node_left)...
Launching right hand node (stark_node_right)...
Both nodes are running. Press Ctrl+C to stop.
```

**功能：**
- 启动左手控制节点（slave_id=126, /dev/ttyUSB0）
- 启动右手控制节点（slave_id=127, /dev/ttyUSB1）
- 创建硬件控制话题：
  - `/set_motor_multi_126` (左手)
  - `/set_motor_multi_127` (右手)

---

### 第 2 步：启动桥接节点

**终端 2** 运行：
```bash
cd /home/scy/stark-serialport-example/ros2_stark_ws
./start_bridge.sh
```

**预期输出：**
```
Hand Control Bridge Node Started
Left hand:  Subscribe /left_hand/motor_commands  → Publish /set_motor_multi_126
Right hand: Subscribe /right_hand/motor_commands → Publish /set_motor_multi_127
Waiting for commands from Vision Pro...
Stats: Left=0 msgs, Right=0 msgs
```

**功能：**
- 订阅 Vision Pro 发布的话题：
  - `/left_hand/motor_commands`
  - `/right_hand/motor_commands`
- 自动转发到硬件控制话题
- 每 2 秒打印统计信息

---

### 第 3 步：运行 Vision Pro 控制脚本

**终端 3** 运行你的 Vision Pro 脚本：

```bash
cd /home/scy/stark-serialport-example/ros2_stark_ws
source /opt/ros/humble/setup.bash
source install/setup.bash
export ROS_DOMAIN_ID=5
python3 your_visionpro_script.py
```

**功能：**
- 从 Vision Pro 获取手势数据
- 进行 retargeting 计算
- 发布到 `/left_hand/motor_commands` 和 `/right_hand/motor_commands`
- 桥接节点会自动转发到硬件

现在你的手势应该能实时控制灵巧手了！

---

## 🧪 测试方法

### 方法 1：自动化测试（推荐）

在启动前两步后，在**终端 3** 运行：

```bash
cd /home/scy/stark-serialport-example/ros2_stark_ws
./run_test.sh
```

**测试内容：**
1. ✓ 张开双手
2. ✓ 握拳
3. ✓ 再次张开
4. ✓ 食指单独测试
5. ✓ 中指单独测试
6. ✓ 无名指单独测试
7. ✓ 小指单独测试
8. ✓ 拇指测试
9. ✓ 平滑闭合动作
10. ✓ 平滑张开动作

整个测试大约需要 30 秒。

---

### 方法 2：手动命令测试

```bash
# 设置 ROS_DOMAIN_ID
export ROS_DOMAIN_ID=5

# 左手握拳
ros2 topic pub --once /left_hand/motor_commands \
  ros2_stark_msgs/msg/SetMotorMulti \
  '{mode: 1, positions: [300, 300, 1000, 1000, 1000, 1000]}'

# 左手张开
ros2 topic pub --once /left_hand/motor_commands \
  ros2_stark_msgs/msg/SetMotorMulti \
  '{mode: 1, positions: [400, 400, 0, 0, 0, 0]}'

# 右手握拳
ros2 topic pub --once /right_hand/motor_commands \
  ros2_stark_msgs/msg/SetMotorMulti \
  '{mode: 1, positions: [300, 300, 1000, 1000, 1000, 1000]}'

# 右手张开
ros2 topic pub --once /right_hand/motor_commands \
  ros2_stark_msgs/msg/SetMotorMulti \
  '{mode: 1, positions: [400, 400, 0, 0, 0, 0]}'
```

---

## 🔍 调试命令

### 查看所有 ROS2 话题
```bash
export ROS_DOMAIN_ID=5
ros2 topic list
```

应该看到：
- `/left_hand/motor_commands`
- `/right_hand/motor_commands`
- `/set_motor_multi_126`
- `/set_motor_multi_127`

### 监控话题数据

```bash
# 监控 Vision Pro 发布的命令
ros2 topic echo /left_hand/motor_commands

# 监控发送到硬件的命令
ros2 topic echo /set_motor_multi_126

# 查看话题发布频率
ros2 topic hz /left_hand/motor_commands
```

### 检查节点状态

```bash
# 查看所有活动节点
ros2 node list

# 查看节点信息
ros2 node info /hand_control_bridge
```

---

## ⚙️ 配置说明

### 环境变量
- **ROS_DOMAIN_ID**: 必须为 `5`（所有终端一致）

### 硬件配置
| 手 | Slave ID | 串口 | 硬件话题 |
|---|---------|------|----------|
| 左手 | 126 (0x7e) | /dev/ttyUSB0 | /set_motor_multi_126 |
| 右手 | 127 (0x7f) | /dev/ttyUSB1 | /set_motor_multi_127 |

### 位置参数范围
- **范围**: [0, 1000]
- **0**: 完全张开
- **1000**: 完全弯曲

### 电机索引
```
positions[0] = 拇指内收/外展 (thumb adduct)
positions[1] = 拇指弯曲 (thumb flex)
positions[2] = 食指弯曲 (index flex)
positions[3] = 中指弯曲 (middle flex)
positions[4] = 无名指弯曲 (ring flex)
positions[5] = 小指弯曲 (pinky flex)
```

---

## 🐛 故障排查

### 问题 1: `ModuleNotFoundError: No module named 'ros2_stark_msgs'`

**原因**: 没有正确设置 ROS2 环境

**解决**: 使用提供的启动脚本
```bash
./run_test.sh        # 测试脚本
./start_bridge.sh    # 桥接节点
```

或手动设置环境：
```bash
source /opt/ros/humble/setup.bash
source install/setup.bash
export ROS_DOMAIN_ID=5
```

---

### 问题 2: 串口权限不足

**错误**: `Permission denied: '/dev/ttyUSB0'`

**解决方案 A** (临时):
```bash
sudo chmod 666 /dev/ttyUSB0
sudo chmod 666 /dev/ttyUSB1
```

**解决方案 B** (永久):
```bash
sudo usermod -aG dialout $USER
# 需要重新登录
```

---

### 问题 3: 桥接节点收不到 Vision Pro 数据

**检查清单**:
1. ✓ 所有终端的 `ROS_DOMAIN_ID` 都是 5
2. ✓ Vision Pro 脚本正常运行
3. ✓ 使用 `ros2 topic list` 检查话题存在
4. ✓ 使用 `ros2 topic echo` 检查数据流

**验证数据流**:
```bash
# 在 Vision Pro 脚本运行时
ros2 topic echo /left_hand/motor_commands
# 应该能看到持续的数据流
```

---

### 问题 4: 灵巧手不动

**检查清单**:
1. ✓ `stark_serial_manager.sh launch` 正常运行
2. ✓ 串口设备存在：`ls -l /dev/ttyUSB*`
3. ✓ 串口权限正确
4. ✓ 硬件供电正常
5. ✓ 使用测试脚本验证基本功能

**测试硬件连接**:
```bash
./run_test.sh
# 如果测试通过，说明硬件连接正常
```

---

### 问题 5: 话题无法连接

**检查 ROS_DOMAIN_ID**:
```bash
# 在每个终端检查
echo $ROS_DOMAIN_ID
# 应该都显示 5
```

**重新设置**:
```bash
export ROS_DOMAIN_ID=5
```

---

## 📊 数据流架构

```
┌─────────────────────┐
│   Vision Pro        │
│  (手势捕捉)         │
└──────────┬──────────┘
           │ 发布
           ↓
┌─────────────────────┐
│ /left_hand/motor_   │
│      commands       │
│ /right_hand/motor_  │
│      commands       │
└──────────┬──────────┘
           │ 订阅
           ↓
┌─────────────────────┐
│ Hand Control Bridge │
│   (桥接节点)        │
└──────────┬──────────┘
           │ 转发
           ↓
┌─────────────────────┐
│ /set_motor_multi_126│
│ /set_motor_multi_127│
└──────────┬──────────┘
           │ 订阅
           ↓
┌─────────────────────┐
│  Stark Node (L/R)   │
│  (硬件控制节点)     │
└──────────┬──────────┘
           │ RS-485
           ↓
┌─────────────────────┐
│    灵巧手硬件       │
│  (左手 126/右手 127)│
└─────────────────────┘
```

---

## 📝 性能优化建议

### 减少日志输出

如果终端输出太多，可以编辑 `hand_control_bridge.py`：

```python
# 第 71-74 行，修改打印频率
if self.left_count % 50 == 0:  # 从 10 改为 50
    self.get_logger().debug(...)

# 第 97-100 行，修改打印频率  
if self.right_count % 50 == 0:  # 从 10 改为 50
    self.get_logger().debug(...)
```

### 调整统计信息频率

```python
# 第 56 行
self.stats_timer = self.create_timer(5.0, self.print_statistics)  # 从 2.0 改为 5.0
```

---

## 📚 相关文档

- **QUICK_START.txt**: 快速启动参考卡片
- **HAND_CONTROL_README.md**: 详细技术文档
- **本文件 (使用指南.md)**: 完整使用流程

---

## 🎯 快速命令速查

```bash
# 启动硬件控制
./stark_serial_manager.sh launch

# 启动桥接节点
./start_bridge.sh

# 运行测试
./run_test.sh

# 查看话题
ros2 topic list

# 监控数据
ros2 topic echo /left_hand/motor_commands

# 检查权限
ls -l /dev/ttyUSB*

# 修复权限
sudo chmod 666 /dev/ttyUSB*
```

---

## 💡 使用技巧

1. **建议使用 tmux 或 screen** 管理多个终端
2. **测试前先运行 `./run_test.sh`** 确保硬件正常
3. **观察桥接节点的统计信息** 判断数据流是否正常
4. **Vision Pro 脚本的位置映射** 已经过校准，直接使用即可
5. **如需调整手势映射**，修改 Vision Pro 脚本中的 retargeting 参数

---

## ✨ 总结

你现在拥有一个完整的 Vision Pro 手势控制系统：

✅ **桥接节点**: 自动转发 Vision Pro 命令到硬件  
✅ **测试工具**: 完整的自动化测试脚本  
✅ **启动脚本**: 一键启动，自动配置环境  
✅ **完整文档**: 使用说明、调试指南、故障排查  

享受你的手势控制灵巧手体验！🎉

